VERSION 0.8

IMPORT ../../../wasm AS wasm
IMPORT github.com/input-output-hk/catalyst-ci/earthly/rust:v3.6.14 AS rust-ci

# Make an artifact which consists of the common code shared by Athena modules.
workspace-src:
    FROM scratch

    WORKDIR /
    COPY --keep-ts --dir shared Cargo.toml .

    SAVE ARTIFACT shared
    SAVE ARTIFACT Cargo.toml

# Athena modules builder.
builder:
    ARG wasi_src_dir=../../../../wasm/wasi

    DO rust-ci+SETUP

    # Install WASI SDK for compiling C code to wasm32-wasip2
    ARG WASI_SDK_VERSION=25
    ARG WASI_SDK_VERSION_FULL=${WASI_SDK_VERSION}.0
    RUN apt-get update && apt-get install -y wget && \
        ARCH=$(dpkg --print-architecture) && \
        if [ "$ARCH" = "amd64" ]; then WASI_ARCH="x86_64"; else WASI_ARCH="arm64"; fi && \
        wget -q https://github.com/WebAssembly/wasi-sdk/releases/download/wasi-sdk-${WASI_SDK_VERSION}/wasi-sdk-${WASI_SDK_VERSION_FULL}-${WASI_ARCH}-linux.tar.gz && \
        tar xzf wasi-sdk-${WASI_SDK_VERSION_FULL}-${WASI_ARCH}-linux.tar.gz && \
        mv wasi-sdk-${WASI_SDK_VERSION_FULL}-${WASI_ARCH}-linux /opt/wasi-sdk && \
        rm wasi-sdk-${WASI_SDK_VERSION_FULL}-${WASI_ARCH}-linux.tar.gz && \
        apt-get clean && rm -rf /var/lib/apt/lists/*

    # Configure environment for wasm32-wasip2 C compilation
    ENV WASI_SDK_PATH="/opt/wasi-sdk"
    ENV CC_wasm32_wasip2="${WASI_SDK_PATH}/bin/clang"
    ENV CFLAGS_wasm32_wasip2="--sysroot=${WASI_SDK_PATH}/share/wasi-sysroot"

    COPY wasm+wasi-src/wasi $wasi_src_dir

# check-shared : runs native unit tests of the shared crate.
check-shared:
    FROM +builder

    COPY +workspace-src/shared .
    DO rust-ci+CARGO --args="test --all-features --release"

# check-shared-wasm32 : checks wasm32 build target of the shared crate.
check-shared-wasm32:
    FROM +builder

    COPY +workspace-src/shared .
    DO rust-ci+CARGO --args="check --all-features  --release --target=wasm32-wasip2"

# builds a wasm32-wasip2 Athena component and saves it as an artifact
BUILD_ATHENA_COMPONENT:
    FUNCTION

    ARG wasi_src_dir=../../../../../wasm/wasi   # where should the /wasi directory reside at compilation
    ARG out=out.wasm                            # name of the saved artifact

    FROM +builder --wasi_src_dir=$wasi_src_dir

    COPY --dir +workspace-src/* .
    COPY --keep-ts --dir src Cargo.toml modules/tmp
    WORKDIR modules/tmp

    DO rust-ci+CARGO \
        --args "build --target wasm32-wasip2 --release" \
        --output="wasm32-wasip2/release/$out"

    SAVE ARTIFACT ../../target/wasm32-wasip2/release/$out $out
