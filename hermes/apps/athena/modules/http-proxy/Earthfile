VERSION 0.8

IMPORT ../../../../ AS hermes
IMPORT ../../../../../wasm/wasi AS wasi
IMPORT ../.. AS athena
    
build-http-proxy:
    DO athena+BUILD_ATHENA_COMPONENT --out=http_proxy.wasm



# Common base for HTTP Proxy builds
# ==================================
# Sets up common files and directory structure used by both production and dev builds.
# This eliminates duplication between local-build-http-proxy and local-build-http-proxy-dev.
http-proxy-base:
    FROM alpine
    COPY +build-http-proxy/http_proxy.wasm .
    
    # Copy module configuration and metadata files
    COPY lib/config.schema.json .
    COPY lib/manifest_module.json .
    COPY lib/metadata.json .
    COPY lib/settings.schema.json .
    
    # Create the missing config.json file (empty JSON object)
    RUN echo '{}' > config.json

    # Create staging directory structure
    RUN mkdir -p /staging/www

    # Copy WASM module and JSON config files to root of staging
    RUN cp http_proxy.wasm /staging/
    RUN cp *.json /staging/ || true

# HTTP Proxy WASM Module Build
# =============================
# Compiles the HTTP proxy Rust code into a WebAssembly module using the wasm32-wasip2 target.
# This creates a sandboxed, portable component that can run in the Hermes runtime.
#
# Build Pipeline:
#   1. Set up Rust toolchain with WASM target support
#   2. Copy source code and dependencies into build container
#   3. Generate and integrate WIT bindings (shared across modules)
#   4. Compile to optimized WASM binary
#   5. Export artifacts for packaging
#
# Compilation Target: wasm32-wasip2 (WebAssembly System Interface Preview 2)
# Optimization: Release mode with size optimizations (opt-level = "z", lto = true)
# Output: http_proxy.wasm - Executable WebAssembly module
# Duration: ~3-5 minutes (Rust compilation to WASM)
local-build-http-proxy:
    FROM +http-proxy-base

    # Download web assets directly to root level
    COPY github.com/input-output-hk/catalyst-voices/catalyst_voices+build-web/web .

    # Copy web assets to www subdirectory
    RUN cp -r assets /staging/www/ || true
    RUN cp -r canvaskit /staging/www/ || true
    RUN cp -r icons /staging/www/ || true

    # Copy all regular files from current directory to staging/www, skip directories
    RUN find . -maxdepth 1 -type f -exec cp {} /staging/www/ \; 2>/dev/null || echo "⚠️  Some files may not have been copied"
    
    # Export build artifacts from staging directory
    SAVE ARTIFACT /staging AS LOCAL lib

# Development build - faster version without heavy web assets
# ============================================================
# This target skips the large web assets (assets, canvaskit, icons) that take
# a long time to download and compress. Use this for development iterations
# where you don't need all the web assets.
#
# What's included:
#   - WASM module (http_proxy.wasm)
#   - JSON configuration files
#   - Essential files only
#
# What's skipped:
#   - Large web assets (assets/, canvaskit/, icons/)
#   - Full catalyst_voices web build
#
local-build-http-proxy-dev:
    FROM +http-proxy-base

    # For dev: Create minimal placeholder assets instead of copying large ones
    RUN mkdir -p /staging/www/assets /staging/www/canvaskit /staging/www/icons
    RUN echo '{"dev": "placeholder"}' > /staging/www/assets/placeholder.json
    RUN echo '{"dev": "placeholder"}' > /staging/www/canvaskit/placeholder.json
    RUN echo '{"dev": "placeholder"}' > /staging/www/icons/placeholder.json
    
    # Export build artifacts from staging directory
    SAVE ARTIFACT /staging AS LOCAL lib
