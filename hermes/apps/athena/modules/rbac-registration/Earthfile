VERSION 0.8

IMPORT github.com/input-output-hk/catalyst-ci/earthly/rust:v3.5.6 AS rust-ci
IMPORT ../../../../ AS hermes
IMPORT ../../../../../wasm/wasi AS wasi
    
# TODO - This can be integrated somewhere in the modules earthfile
build-rbac-registration:
    DO rust-ci+SETUP

    WORKDIR /app

    COPY --keep-ts --dir src .
    COPY Cargo.toml .
    COPY wasi+build-rust-bindings/hermes.rs src/hermes.rs

    
    DO rust-ci+CARGO \
        --args "build --target wasm32-wasip2 --release" \
        --output="wasm32-wasip2/release/rbac_registration.wasm"
    
    SAVE ARTIFACT target/wasm32-wasip2/release/rbac_registration.wasm rbac_registration.wasm

save-local-rbac-registration:
    FROM scratch
    COPY +build-rbac-registration/rbac_registration.wasm .
    SAVE ARTIFACT rbac_registration.wasm AS LOCAL .

package-rbac-registration-module:
    FROM hermes+build
    
    COPY lib/config.schema.json .
    COPY lib/config.json .
    COPY lib/manifest_module.json .
    COPY lib/metadata.json .
    COPY lib/settings.schema.json .
    COPY +build-rbac-registration/rbac_registration.wasm .

    RUN target/release/hermes module package manifest_module.json
    SAVE ARTIFACT rbac-registration.hmod
