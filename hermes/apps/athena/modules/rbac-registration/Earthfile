VERSION 0.8

IMPORT github.com/input-output-hk/catalyst-ci/earthly/rust:v3.5.6 AS rust-ci
IMPORT ../../../../ AS hermes
IMPORT ../../../../../wasm/wasi AS wasi
    
build-rbac-registration:
    DO rust-ci+SETUP

    WORKDIR /app

    COPY --keep-ts --dir src .
    COPY Cargo.toml .
    COPY wasi+build-rust-bindings/hermes.rs src/hermes.rs

    
    DO rust-ci+CARGO \
        --args "build --target wasm32-wasip2 --release" \
        --output="wasm32-wasip2/release/rbac_registration.wasm"
    
    SAVE ARTIFACT target/wasm32-wasip2/release/rbac_registration.wasm rbac_registration.wasm

local-build-rbac-registration:
    FROM scratch
    COPY +build-rbac-registration/rbac_registration.wasm .
    SAVE ARTIFACT rbac_registration.wasm AS LOCAL lib/rbac_registration.wasm


package-rbac-registration-module:
    FROM hermes+build
    
    COPY lib/ .
    COPY +build-rbac-registration/rbac_registration.wasm .

    RUN ./target/release/hermes module package manifest_module.json
    SAVE ARTIFACT rbac_registration.hmod
