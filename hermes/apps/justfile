# Build the Hermes binary in release mode using Earthly
build-hermes:
    #!/usr/bin/env bash
    set -euo pipefail
    
    echo "ðŸ”¨ Building Hermes binary with Earthly..."
    earthly ./athena/modules+build-hermes
    
    # Ensure target directory exists
    mkdir -p ../target/release
    
    # Copy the binary from the new location in modules
    cp ./athena/modules/hermes ../target/release/hermes
    chmod +x ../target/release/hermes
    
    echo "âœ… Hermes build complete!"

# Build and package the Athena HTTP proxy component
build-athena:
    #!/usr/bin/env bash
    set -euo pipefail
    
    echo "ðŸ”¨ Building HTTP proxy WASM component..."
    earthly ./athena/modules+build-http-proxy
    
    echo "ðŸ“¦ Packaging module..."
    ../target/release/hermes module package athena/modules/http-proxy/lib/manifest_module.json
    
    echo "ðŸ“¦ Packaging application..."
    ../target/release/hermes app package athena/manifest_app.json
    
    echo "âœ… Build and packaging complete!"

# Clean up .hfs files from ~/.hermes/
clean-hfs:
    @if [ -d ~/.hermes ]; then \
        find ~/.hermes -name "*.hfs" -type f -delete 2>/dev/null || true; \
        echo "Cleaned up .hfs files from ~/.hermes/"; \
    else \
        echo "~/.hermes/ directory does not exist"; \
    fi

# Run the Athena application using release binary
run-athena:
    #!/usr/bin/env bash
    set -euo pipefail
    
    echo "ðŸš€ Running Athena application..."
    export REDIRECT_ALLOWED_PATH_PREFIXES="${REDIRECT_ALLOWED_PATH_PREFIXES:-/fact}"
    export REDIRECT_ALLOWED_HOSTS="${REDIRECT_ALLOWED_HOSTS:-catfact.ninja}"
    ../target/release/hermes run --untrusted athena/app.happ

# Build everything and run Athena
build-run-all: clean-hfs build-hermes build-athena run-athena