# Docker Compose for Hermes P2P Testing
# Simulates multiple computers running Hermes with isolated networks
#
# IMPORTANT: Before running, build artifacts with Earthly for cross-platform compatibility:
#   just get-local-hermes    # Containerized build (GLIBC-compatible)
#   just get-local-athena    # WASM build + packaging
#
# Or simply run: ./start-nodes.sh (handles builds automatically)

services:
  hermes-node1:
    build:
      context: ..
      dockerfile: p2p-testing/Dockerfile
    container_name: hermes-node1
    hostname: node1
    environment:
      - HERMES_HTTP_PORT=5000
      - HERMES_ACTIVATE_AUTH=true
      - REDIRECT_ALLOWED_HOSTS=app.dev.projectcatalyst.io
      - REDIRECT_ALLOWED_PATH_PREFIXES=/api/gateway/v1/config/frontend,/api/gateway/v1/cardano/assets,/api/gateway/v1/rbac/registration
      - RUST_LOG=hermes::ipfs=debug,rust_ipfs=debug,libp2p=debug,hermes=info
      - IPFS_BOOTSTRAP_PEERS=/ip4/172.20.0.11/tcp/4001/p2p/12D3KooWBkdsbenzeixaTmEXdmpf5P2pXtyvm4Qb4sGZJ1Wi4BUB,/ip4/172.20.0.12/tcp/4001/p2p/12D3KooWA5tEBmYCXQfmAdt5zZonBouBt2KBN6umaUtdQVY39GPK
    ports:
      # HTTP Gateway
      - "5000:5000"
      # IPFS Swarm (P2P)
      - "4001:4001"
      # IPFS API
      - "5001:5001"
    volumes:
      - node1-data:/home/hermes
    networks:
      hermes-p2p:
        ipv4_address: 172.20.0.10

  hermes-node2:
    build:
      context: ..
      dockerfile: p2p-testing/Dockerfile
    container_name: hermes-node2
    hostname: node2
    environment:
      - HERMES_HTTP_PORT=5000
      - HERMES_ACTIVATE_AUTH=true
      - REDIRECT_ALLOWED_HOSTS=app.dev.projectcatalyst.io
      - REDIRECT_ALLOWED_PATH_PREFIXES=/api/gateway/v1/config/frontend,/api/gateway/v1/cardano/assets,/api/gateway/v1/rbac/registration
      - RUST_LOG=hermes::ipfs=debug,rust_ipfs=debug,libp2p=debug,hermes=info
      - IPFS_BOOTSTRAP_PEERS=/ip4/172.20.0.10/tcp/4001/p2p/12D3KooWBxass2EcccdN5FzC2e6er3uyuYJkTchMX11iKWaJ9aj1,/ip4/172.20.0.12/tcp/4001/p2p/12D3KooWA5tEBmYCXQfmAdt5zZonBouBt2KBN6umaUtdQVY39GPK
    ports:
      # HTTP Gateway (different host port)
      - "5002:5000"
      # IPFS Swarm
      - "4002:4001"
      # IPFS API
      - "5003:5001"
    volumes:
      - node2-data:/home/hermes
    networks:
      hermes-p2p:
        ipv4_address: 172.20.0.11

  hermes-node3:
    build:
      context: ..
      dockerfile: p2p-testing/Dockerfile
    container_name: hermes-node3
    hostname: node3
    environment:
      - HERMES_HTTP_PORT=5000
      - HERMES_ACTIVATE_AUTH=true
      - REDIRECT_ALLOWED_HOSTS=app.dev.projectcatalyst.io
      - REDIRECT_ALLOWED_PATH_PREFIXES=/api/gateway/v1/config/frontend,/api/gateway/v1/cardano/assets,/api/gateway/v1/rbac/registration
      - RUST_LOG=hermes::ipfs=debug,rust_ipfs=debug,libp2p=debug,hermes=info
      - IPFS_BOOTSTRAP_PEERS=/ip4/172.20.0.10/tcp/4001/p2p/12D3KooWBxass2EcccdN5FzC2e6er3uyuYJkTchMX11iKWaJ9aj1,/ip4/172.20.0.11/tcp/4001/p2p/12D3KooWBkdsbenzeixaTmEXdmpf5P2pXtyvm4Qb4sGZJ1Wi4BUB
    ports:
      # HTTP Gateway (different host port)
      - "5004:5000"
      # IPFS Swarm
      - "4003:4001"
      # IPFS API
      - "5005:5001"
    volumes:
      - node3-data:/home/hermes
    networks:
      hermes-p2p:
        ipv4_address: 172.20.0.12

networks:
  hermes-p2p:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  node1-data:
  node2-data:
  node3-data:
