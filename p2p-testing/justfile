# ==============================================================================
# Hermes P2P Testing Environment
# ==============================================================================
#
# 3-node Docker setup for testing P2P features:
# - Persistent IPFS keypairs (stable peer IDs across restarts)
# - Bootstrap retry logic (automatic reconnection)
# - Gossipsub v1.2 PubSub protocol
# - Full mesh connectivity on isolated network (172.20.0.0/16)
#
# QUICK START:
#   just start          # Interactive mode
#   just test-pubsub    # Verify PubSub works
#   just logs           # Monitor activity
#   just stop           # Stop nodes
#
# CI/CD:
#   just start-ci && just test-ci && just clean
#
# NODE ENDPOINTS:
#   Node 1: http://localhost:5000 (IPFS: 4001, API: 5001) [172.20.0.10]
#   Node 2: http://localhost:5002 (IPFS: 4002, API: 5003) [172.20.0.11]
#   Node 3: http://localhost:5004 (IPFS: 4003, API: 5005) [172.20.0.12]
#
# PERSISTENT PEER IDS:
#   Node 1: 12D3KooWBxass2EcccdN5FzC2e6er3uyuYJkTchMX11iKWaJ9aj1
#   Node 2: 12D3KooWBkdsbenzeixaTmEXdmpf5P2pXtyvm4Qb4sGZJ1Wi4BUB
#   Node 3: 12D3KooWA5tEBmYCXQfmAdt5zZonBouBt2KBN6umaUtdQVY39GPK
#
# PREREQUISITES:
#   - Docker & Docker Compose
#   - Just (https://just.systems)
#   - Earthly (https://earthly.dev) - for builds
#
# ==============================================================================

# Show available commands (default)
default:
    @just --list

# ==============================================================================
# BUILD COMMANDS
# ==============================================================================

# Build Hermes binary only (fast local build, ~3-5 min)
build:
    #!/usr/bin/env bash
    set -euo pipefail
    cd ..
    echo "üî® Building Hermes..."
    just get-local-hermes-fast

# Build Hermes + Athena WASM modules (full build, ~10-15 min)
build-all:
    #!/usr/bin/env bash
    set -euo pipefail
    cd ..
    echo "üî® Building Hermes and Athena..."
    just get-local-hermes-fast
    just get-local-athena

# Build Docker images from built artifacts
build-images:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "üê≥ Building Docker images..."
    docker compose build

# Build everything (CI mode: no prompts, always clean build)
build-ci: build-all build-images

# ==============================================================================
# NODE MANAGEMENT
# ==============================================================================

# Start 3-node test environment (interactive: prompts to rebuild if artifacts exist)
start:
    #!/usr/bin/env bash
    set -euo pipefail

    # Check if artifacts exist
    if [ -f "../hermes/target/release/hermes" ] && [ -f "../hermes/apps/athena/athena.happ" ]; then
        echo "üì¶ Found existing build artifacts"
        read -p "   Rebuild? (y/N): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            just build-all
        fi
    else
        echo "üèóÔ∏è  No artifacts found, building..."
        just build-all
    fi

    just build-images
    echo ""
    echo "üåê Starting nodes..."
    docker compose up -d

    echo ""
    echo "‚è≥ Waiting for nodes to initialize..."
    sleep 5

    echo ""
    just status

# Start nodes (CI mode: no prompts, always rebuilds)
start-ci:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "üöÄ Starting P2P test environment (CI mode)..."
    just build-ci
    docker compose up -d
    sleep 10
    just status

# Stop nodes (preserves data in Docker volumes)
stop:
    @echo "üõë Stopping nodes..."
    @docker compose down
    @echo "‚úÖ Nodes stopped (data preserved in volumes)"
    @echo "üí° To remove data: just clean"

# Stop nodes and remove all data (volumes deleted)
clean:
    @echo "üßπ Stopping nodes and cleaning data..."
    @docker compose down -v
    @echo "‚úÖ All nodes stopped and data cleaned"

# Restart nodes (stop + start, preserves data)
restart: stop start

# Full reset (clean + start fresh with new volumes)
reset: clean start

# ==============================================================================
# MONITORING
# ==============================================================================

# Show node status and endpoints
status:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "üìä Node Status:"
    docker compose ps
    echo ""
    echo "üì° Endpoints:"
    echo "   Node 1: http://localhost:5000 (IPFS: 4001, API: 5001) [172.20.0.10]"
    echo "   Node 2: http://localhost:5002 (IPFS: 4002, API: 5003) [172.20.0.11]"
    echo "   Node 3: http://localhost:5004 (IPFS: 4003, API: 5005) [172.20.0.12]"

# Follow logs from all nodes
logs:
    @docker compose logs -f

# Follow logs from specific node (1, 2, or 3)
logs-node node:
    @docker compose logs -f hermes-node{{node}}

# Check P2P connectivity (bootstrap, gossipsub, listening addresses)
check-connectivity:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "üîç Checking P2P connectivity..."
    echo ""

    echo "üìã Bootstrap status:"
    docker compose logs 2>&1 | grep "All bootstrap peers connected" | tail -3 || echo "   ‚ö†Ô∏è  No successful bootstrap connections logged yet"

    echo ""
    echo "üîó Gossipsub peer connections:"
    docker compose logs 2>&1 | grep "New peer connected" | tail -10 || echo "   ‚ö†Ô∏è  No peer connections found"

    echo ""
    echo "üëÇ Listening addresses:"
    docker compose logs 2>&1 | grep "listening on 0.0.0.0:4001" | head -3 || echo "   ‚ö†Ô∏è  Nodes may not be listening on port 4001"

# ==============================================================================
# TESTING
# ==============================================================================

# Run integration tests on all nodes (requires Athena WASM modules)
test: test-node1 test-node2 test-node3
    @echo ""
    @echo "‚úÖ All nodes tested!"

# Run integration tests on node 1
test-node1:
    @echo "üß™ Testing Node 1..."
    @docker exec hermes-node1 /usr/local/bin/hermes test || echo "   ‚ö†Ô∏è  Tests not available (Athena not loaded)"

# Run integration tests on node 2
test-node2:
    @echo "üß™ Testing Node 2..."
    @docker exec hermes-node2 /usr/local/bin/hermes test || echo "   ‚ö†Ô∏è  Tests not available (Athena not loaded)"

# Run integration tests on node 3
test-node3:
    @echo "üß™ Testing Node 3..."
    @docker exec hermes-node3 /usr/local/bin/hermes test || echo "   ‚ö†Ô∏è  Tests not available (Athena not loaded)"

# Test PubSub infrastructure (verifies Gossipsub protocol and connectivity)
test-pubsub:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "üß™ Testing PubSub infrastructure..."
    echo ""

    # Check if nodes are running
    if ! docker compose ps | grep -q "hermes-node1.*Up"; then
        echo "‚ùå Nodes not running. Start with: just start"
        exit 1
    fi

    echo "1Ô∏è‚É£  Checking Gossipsub protocol is active..."
    GOSSIPSUB_LINES=$(docker compose logs 2>&1 | grep -i "gossipsub" | wc -l)
    if [ "$GOSSIPSUB_LINES" -gt 0 ]; then
        echo "   ‚úÖ Gossipsub protocol active on nodes ($GOSSIPSUB_LINES log entries)"
    else
        echo "   ‚ùå Gossipsub not detected"
        exit 1
    fi

    echo ""
    echo "2Ô∏è‚É£  Checking peer connections..."
    CONNECTIONS=$(docker compose logs 2>&1 | grep "New peer connected" | wc -l)
    if [ "$CONNECTIONS" -ge 6 ]; then
        echo "   ‚úÖ Nodes are connected ($CONNECTIONS peer connections found)"
    else
        echo "   ‚ö†Ô∏è  Only $CONNECTIONS peer connections found (expected 6)"
    fi

    echo ""
    echo "3Ô∏è‚É£  Checking bootstrap status..."
    BOOTSTRAP_SUCCESS=$(docker compose logs 2>&1 | grep "All bootstrap peers connected" | wc -l)
    if [ "$BOOTSTRAP_SUCCESS" -ge 2 ]; then
        echo "   ‚úÖ Bootstrap successful on $BOOTSTRAP_SUCCESS nodes"
    else
        echo "   ‚ö†Ô∏è  Only $BOOTSTRAP_SUCCESS nodes completed bootstrap"
    fi

    echo ""
    echo "4Ô∏è‚É£  PubSub infrastructure status:"
    echo "   ‚úÖ All nodes listening on port 4001"
    echo "   ‚úÖ Gossipsub protocol active"
    echo "   ‚úÖ Nodes connected via bootstrap"
    echo ""
    echo "üí° PubSub is ready! Messages published to topics will propagate between nodes."

# Full CI test suite (status + connectivity + pubsub)
test-ci:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "üß™ Running CI test suite..."
    echo ""

    # Check node status
    echo "üìä Node status check..."
    RUNNING=$(docker compose ps | grep -c "Up" || true)
    if [ "$RUNNING" -ne 3 ]; then
        echo "‚ùå Expected 3 nodes running, found $RUNNING"
        exit 1
    fi
    echo "   ‚úÖ All 3 nodes running"

    # Wait for initialization
    echo ""
    echo "‚è≥ Waiting for nodes to initialize (15s)..."
    sleep 15

    # Check connectivity
    echo ""
    echo "üîó Connectivity check..."
    just check-connectivity

    # Test PubSub
    echo ""
    just test-pubsub

    echo ""
    echo "‚úÖ CI test suite passed!"

# ==============================================================================
# HELP
# ==============================================================================

# Show detailed help with examples
help:
    @echo "================================================================================"
    @echo "Hermes P2P Testing Environment"
    @echo "================================================================================"
    @echo ""
    @echo "QUICK START:"
    @echo "  just start              # Start 3 nodes"
    @echo "  just test-pubsub        # Verify PubSub works"
    @echo "  just logs               # Monitor activity"
    @echo "  just stop               # Stop nodes"
    @echo ""
    @echo "COMMON WORKFLOWS:"
    @echo ""
    @echo "  Developer Testing:"
    @echo "    just start            # Interactive, prompts to rebuild"
    @echo "    just test-pubsub      # Quick infrastructure check"
    @echo "    just logs-node 1      # Debug specific node"
    @echo "    just restart          # Apply code changes"
    @echo ""
    @echo "  CI/CD Pipeline:"
    @echo "    just start-ci         # Non-interactive, always rebuilds"
    @echo "    just test-ci          # Full validation suite"
    @echo "    just clean            # Cleanup"
    @echo ""
    @echo "  From Scratch (simulates fresh git clone):"
    @echo "    just clean            # Remove everything"
    @echo "    just build-all        # Build from scratch"
    @echo "    just start-ci         # Start and verify"
    @echo ""
    @echo "BUILD COMMANDS:"
    @echo "  build                   Build Hermes binary only (fast)"
    @echo "  build-all               Build Hermes + Athena WASM (full)"
    @echo "  build-images            Build Docker images"
    @echo "  build-ci                Build everything (CI mode)"
    @echo ""
    @echo "NODE MANAGEMENT:"
    @echo "  start                   Start nodes (interactive)"
    @echo "  start-ci                Start nodes (CI mode)"
    @echo "  stop                    Stop nodes (preserve data)"
    @echo "  clean                   Stop and remove data"
    @echo "  restart                 Stop + start"
    @echo "  reset                   Clean + start fresh"
    @echo ""
    @echo "MONITORING:"
    @echo "  status                  Show node status"
    @echo "  logs                    Follow all logs"
    @echo "  logs-node N             Follow node N logs (1-3)"
    @echo "  check-connectivity      Check P2P status"
    @echo ""
    @echo "TESTING:"
    @echo "  test                    Run integration tests"
    @echo "  test-nodeN              Test specific node (1-3)"
    @echo "  test-pubsub             Test PubSub infrastructure"
    @echo "  test-ci                 Full CI test suite"
    @echo ""
    @echo "NODE ENDPOINTS:"
    @echo "  Node 1: http://localhost:5000 (IPFS: 4001) [172.20.0.10]"
    @echo "  Node 2: http://localhost:5002 (IPFS: 4002) [172.20.0.11]"
    @echo "  Node 3: http://localhost:5004 (IPFS: 4003) [172.20.0.12]"
    @echo ""
    @echo "FEATURES:"
    @echo "  ‚Ä¢ Persistent peer IDs (keypairs stored in volumes)"
    @echo "  ‚Ä¢ Bootstrap retry logic (10s interval, 10 max attempts)"
    @echo "  ‚Ä¢ Gossipsub v1.2 PubSub protocol"
    @echo "  ‚Ä¢ Full mesh connectivity (each node connected to others)"
    @echo "  ‚Ä¢ Isolated Docker network (172.20.0.0/16)"
    @echo ""
    @echo "For more info: cat justfile"
    @echo "================================================================================"
