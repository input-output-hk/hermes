# ==============================================================================
# Hermes P2P Testing Environment
# ==============================================================================
#
# 6-node Docker setup for testing P2P features:
# - Persistent IPFS keypairs via PR#694 (peer IDs stable across stop/restart)
# - Dynamic bootstrap discovery (syncs docker-compose.yml after volume clean)
# - Bootstrap retry logic (automatic reconnection on failures)
# - Gossipsub v1.2 PubSub with on-topic event handler
# - Full mesh connectivity on isolated network (172.20.0.0/16)
#
# WHY 6 NODES?
#   Gossipsub default mesh_n=6 requires at least 6 peers for optimal operation.
#   With fewer nodes, PubSub publish operations block waiting for mesh to form.
#   Alternative would be forking rust-ipfs to add small mesh configuration support.
#
# QUICK START (first time):
#   just build-all && just build-images  # Build everything
#   just init-bootstrap                  # Discover peer IDs (REQUIRED after clean)
#   just test-pubsub                     # Verify PubSub works
#
# DAILY WORKFLOW:
#   just start          # Start nodes (preserves peer IDs)
#   just test-pubsub    # Test PubSub propagation
#   just logs           # Monitor activity
#   just stop           # Stop nodes (keeps data)
#
# AFTER CLEANING VOLUMES:
#   just clean          # Deletes volumes + peer identities
#   just init-bootstrap # REQUIRED: Rediscovers peer IDs before start
#
# CI/CD:
#   just start-ci && just test-ci && just clean
#
# NODE ENDPOINTS:
#   Node 1: http://localhost:5000 (IPFS: 4001, API: 5001) [172.20.0.10]
#   Node 2: http://localhost:5002 (IPFS: 4002, API: 5003) [172.20.0.11]
#   Node 3: http://localhost:5004 (IPFS: 4003, API: 5005) [172.20.0.12]
#   Node 4: http://localhost:5006 (IPFS: 4004, API: 5007) [172.20.0.13]
#   Node 5: http://localhost:5008 (IPFS: 4005, API: 5009) [172.20.0.14]
#   Node 6: http://localhost:5010 (IPFS: 4006, API: 5011) [172.20.0.15]
#
# PERSISTENT PEER IDS (nodes 1-3, 4-6 generated on first run):
#   Node 1: 12D3KooWBxass2EcccdN5FzC2e6er3uyuYJkTchMX11iKWaJ9aj1
#   Node 2: 12D3KooWBkdsbenzeixaTmEXdmpf5P2pXtyvm4Qb4sGZJ1Wi4BUB
#   Node 3: 12D3KooWA5tEBmYCXQfmAdt5zZonBouBt2KBN6umaUtdQVY39GPK
#
# PREREQUISITES:
#   - Docker & Docker Compose
#   - Just (https://just.systems)
#   - Earthly (https://earthly.dev) - for builds
#
# ==============================================================================

# Show available commands (default)
default:
    @just --list

# ==============================================================================
# QUICK START
# ==============================================================================

# Complete end-to-end setup and test (for first-time users)
quickstart:
    #!/usr/bin/env bash
    set -euo pipefail

    # Color codes
    GREEN='\033[32m'
    RED='\033[31m'
    YELLOW='\033[33m'
    BLUE='\033[34m'
    BOLD='\033[1m'
    RESET='\033[0m'

    echo ""
    echo -e "${BOLD}${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${RESET}"
    echo -e "${BOLD}${BLUE}â•‘          Hermes P2P Testing - Quick Start                 â•‘${RESET}"
    echo -e "${BOLD}${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo ""

    # Step 1: Validate prerequisites
    echo -e "${BOLD}Step 1/7:${RESET} Validating prerequisites..."
    if ! just validate-prereqs; then
        echo ""
        echo -e "${RED}âŒ Quickstart failed: Prerequisites not met${RESET}"
        exit 1
    fi

    # Step 2: Check/build artifacts
    echo -e "${BOLD}Step 2/7:${RESET} Checking build artifacts..."
    if [ ! -f "../hermes/target/release/hermes" ] || [ ! -f "../hermes/apps/athena/athena.happ" ]; then
        echo -e "  ${YELLOW}Building Hermes and Athena...${RESET}"
        just build-all || {
            echo -e "${RED}âŒ Build failed${RESET}"
            exit 1
        }
    else
        echo -e "  ${GREEN}âœ… Artifacts already exist${RESET}"
    fi

    # Step 3: Build Docker images
    echo ""
    echo -e "${BOLD}Step 3/7:${RESET} Building Docker images..."
    just build-images || {
        echo -e "${RED}âŒ Image build failed${RESET}"
        exit 1
    }

    # Step 4: Start nodes
    echo ""
    echo -e "${BOLD}Step 4/7:${RESET} Starting 6-node environment..."

    # Check if nodes already running
    if docker compose ps | grep -q "Up"; then
        echo -e "  ${YELLOW}âš ï¸  Nodes already running. Restarting...${RESET}"
        docker compose down
        sleep 2
    fi

    # Check if volumes exist (first time needs init-bootstrap)
    VOLUME_EXISTS=$(docker volume ls | grep p2p-testing_node1-data || echo "")
    if [ -z "$VOLUME_EXISTS" ]; then
        echo -e "  ${BLUE}â„¹ï¸  First time setup - initializing bootstrap...${RESET}"
        just init-bootstrap || {
            echo -e "${RED}âŒ Bootstrap initialization failed${RESET}"
            exit 1
        }
    else
        docker compose up -d || {
            echo -e "${RED}âŒ Failed to start nodes${RESET}"
            exit 1
        }
    fi

    # Step 5: Wait for mesh formation
    echo ""
    echo -e "${BOLD}Step 5/7:${RESET} Waiting for mesh formation..."
    for i in {30..1}; do
        echo -ne "  â³ ${i}s remaining...\r"
        sleep 1
    done
    echo -e "  ${GREEN}âœ… Wait complete${RESET}                    "

    # Step 6: Health check
    echo ""
    echo -e "${BOLD}Step 6/7:${RESET} Running health check..."
    if just health-check; then
        echo ""
    else
        echo ""
        echo -e "${YELLOW}âš ï¸  Health check found issues, but continuing...${RESET}"
        echo ""
    fi

    # Step 7: Test propagation
    echo -e "${BOLD}Step 7/7:${RESET} Testing PubSub propagation..."
    echo ""
    if just test-pubsub-propagation; then
        echo ""
        echo -e "${BOLD}${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${RESET}"
        echo -e "${BOLD}${GREEN}â•‘                  ðŸŽ‰ SUCCESS! ðŸŽ‰                            â•‘${RESET}"
        echo -e "${BOLD}${GREEN}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${RESET}"
        echo -e "${BOLD}${GREEN}â•‘  P2P mesh is operational and message propagation works!   â•‘${RESET}"
        echo -e "${BOLD}${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
        echo ""
        echo -e "${BOLD}Node Endpoints:${RESET}"
        echo "  â€¢ Node 1: http://localhost:5000"
        echo "  â€¢ Node 2: http://localhost:5002"
        echo "  â€¢ Node 3: http://localhost:5004"
        echo "  â€¢ Node 4: http://localhost:5006"
        echo "  â€¢ Node 5: http://localhost:5008"
        echo "  â€¢ Node 6: http://localhost:5010"
        echo ""
        echo -e "${BOLD}Next Steps:${RESET}"
        echo "  â€¢ View logs: ${BLUE}just logs${RESET}"
        echo "  â€¢ Check status: ${BLUE}just dashboard${RESET}"
        echo "  â€¢ Test again: ${BLUE}just test-pubsub-propagation${RESET}"
        echo "  â€¢ Stop nodes: ${BLUE}just stop${RESET}"
        echo ""
    else
        echo ""
        echo -e "${RED}âŒ Propagation test failed${RESET}"
        echo ""
        echo "Troubleshooting:"
        echo "  â€¢ Check logs: ${BLUE}just logs${RESET}"
        echo "  â€¢ Run diagnostics: ${BLUE}just troubleshoot${RESET}"
        echo "  â€¢ Try restarting: ${BLUE}just restart${RESET}"
        exit 1
    fi

# ==============================================================================
# BUILD COMMANDS
# ==============================================================================

# Build Hermes binary only (fast local build, ~3-5 min)
build:
    #!/usr/bin/env bash
    set -euo pipefail
    cd ..
    echo "ðŸ”¨ Building Hermes..."
    just get-local-hermes-fast

# Build Hermes + Athena WASM modules (fast local build, ~1-2 min)
build-all:
    #!/usr/bin/env bash
    set -euo pipefail
    cd ..
    echo "ðŸš€ Building Hermes and Athena..."
    just get-local-hermes-fast
    just get-local-athena-fast

    echo "ðŸ“¦ Packaging modules..."
    cd hermes/apps/athena
    for module_path in modules/*/lib/manifest_module.json; do
        if [ -f "$module_path" ]; then
            echo "  ðŸ“¦ Packaging $(dirname $(dirname $module_path))..."
            ../../../target/release/hermes module package "$module_path" &
        fi
    done
    wait

    echo "ðŸ“¦ Packaging application..."
    ../../../target/release/hermes app package manifest_app.json
    echo "âœ… Build complete!"

# Build Docker images from built artifacts
build-images:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "ðŸ³ Building Docker images..."
    docker compose build

# Build everything (CI mode: no prompts, always clean build)
build-ci: build-all build-images

# ==============================================================================
# VALIDATION & DIAGNOSTICS
# ==============================================================================

# Validate all prerequisites before running tests
validate-prereqs:
    #!/usr/bin/env bash
    set -euo pipefail

    # Color codes
    GREEN='\033[32m'
    RED='\033[31m'
    YELLOW='\033[33m'
    BLUE='\033[34m'
    RESET='\033[0m'

    echo -e "${BLUE}ðŸ” Validating Prerequisites${RESET}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""

    ERRORS=0

    # Check Docker daemon
    echo -n "  Docker daemon... "
    if docker info &>/dev/null; then
        echo -e "${GREEN}âœ…${RESET}"
    else
        echo -e "${RED}âŒ${RESET}"
        echo -e "    ${RED}Docker is not running${RESET}"
        echo -e "    ${YELLOW}â†’ Start Docker: sudo systemctl start docker${RESET}"
        ERRORS=$((ERRORS + 1))
    fi

    # Check Docker Compose
    echo -n "  Docker Compose... "
    if command -v docker &>/dev/null && docker compose version &>/dev/null; then
        echo -e "${GREEN}âœ…${RESET}"
    else
        echo -e "${RED}âŒ${RESET}"
        echo -e "    ${RED}Docker Compose not found${RESET}"
        echo -e "    ${YELLOW}â†’ Install: https://docs.docker.com/compose/install/${RESET}"
        ERRORS=$((ERRORS + 1))
    fi

    # Check Hermes binary
    echo -n "  Hermes binary... "
    if [ -f "../hermes/target/release/hermes" ]; then
        echo -e "${GREEN}âœ…${RESET}"
    else
        echo -e "${RED}âŒ${RESET}"
        echo -e "    ${RED}Binary not found: ../hermes/target/release/hermes${RESET}"
        echo -e "    ${YELLOW}â†’ Build: just build${RESET}"
        ERRORS=$((ERRORS + 1))
    fi

    # Check Athena app
    echo -n "  Athena app... "
    if [ -f "../hermes/apps/athena/athena.happ" ]; then
        echo -e "${GREEN}âœ…${RESET}"
    else
        echo -e "${RED}âŒ${RESET}"
        echo -e "    ${RED}App not found: ../hermes/apps/athena/athena.happ${RESET}"
        echo -e "    ${YELLOW}â†’ Build: just build-all${RESET}"
        ERRORS=$((ERRORS + 1))
    fi

    # Check disk space
    echo -n "  Disk space... "
    AVAILABLE=$(df -BG . | tail -1 | awk '{print $4}' | sed 's/G//')
    if [ "$AVAILABLE" -gt 5 ]; then
        echo -e "${GREEN}âœ… ${AVAILABLE}GB available${RESET}"
    else
        echo -e "${YELLOW}âš ï¸  Only ${AVAILABLE}GB available${RESET}"
        echo -e "    ${YELLOW}â†’ Consider freeing up space: docker system prune${RESET}"
    fi

    # Check ports (only if Docker is running)
    if docker info &>/dev/null; then
        echo -n "  Port availability... "
        PORTS_IN_USE=()
        for PORT in 5000 5002 5004 5006 5008 5010 4001 4002 4003 4004 4005 4006; do
            if ss -tuln 2>/dev/null | grep -q ":$PORT " || netstat -tuln 2>/dev/null | grep -q ":$PORT "; then
                # Check if it's our own containers
                if ! docker compose ps 2>/dev/null | grep -q "Up.*:$PORT"; then
                    PORTS_IN_USE+=($PORT)
                fi
            fi
        done

        if [ ${#PORTS_IN_USE[@]} -eq 0 ]; then
            echo -e "${GREEN}âœ…${RESET}"
        else
            echo -e "${YELLOW}âš ï¸  Ports in use: ${PORTS_IN_USE[*]}${RESET}"
            echo -e "    ${YELLOW}â†’ Check what's using them: lsof -i :PORT${RESET}"
            echo -e "    ${YELLOW}â†’ Or stop our nodes: just stop${RESET}"
        fi
    fi

    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    if [ $ERRORS -eq 0 ]; then
        echo -e "${GREEN}âœ… All prerequisites satisfied!${RESET}"
        echo ""
        exit 0
    else
        echo -e "${RED}âŒ Found $ERRORS issue(s). Please fix them before continuing.${RESET}"
        echo ""
        exit 1
    fi

# Comprehensive health check of running environment
health-check:
    #!/usr/bin/env bash
    set -euo pipefail

    # Color codes
    GREEN='\033[32m'
    RED='\033[31m'
    YELLOW='\033[33m'
    BLUE='\033[34m'
    RESET='\033[0m'

    echo -e "${BLUE}ðŸ¥ Health Check${RESET}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""

    ISSUES=0

    # Check if nodes are running
    echo -e "${BLUE}ðŸ“Š Node Status:${RESET}"
    RUNNING_NODES=$(docker compose ps --format json 2>/dev/null | jq -s 'map(select(.State == "running")) | length' 2>/dev/null || echo "0")

    if [ "$RUNNING_NODES" -eq 6 ]; then
        echo -e "  ${GREEN}âœ… All 6 nodes running${RESET}"
    elif [ "$RUNNING_NODES" -gt 0 ]; then
        echo -e "  ${YELLOW}âš ï¸  Only $RUNNING_NODES/6 nodes running${RESET}"
        ISSUES=$((ISSUES + 1))
    else
        echo -e "  ${RED}âŒ No nodes running${RESET}"
        echo -e "    ${YELLOW}â†’ Start nodes: just start${RESET}"
        echo ""
        exit 1
    fi

    # Check peer connections
    echo ""
    echo -e "${BLUE}ðŸ”— Peer Connections:${RESET}"
    CONN_COUNT=$(docker compose logs 2>&1 | grep -c "New peer connected" || echo "0")
    if [ "$CONN_COUNT" -ge 30 ]; then
        echo -e "  ${GREEN}âœ… Full mesh connected ($CONN_COUNT peer connections)${RESET}"
    elif [ "$CONN_COUNT" -ge 15 ]; then
        echo -e "  ${YELLOW}âš ï¸  Partial mesh ($CONN_COUNT connections, expected 30)${RESET}"
        ISSUES=$((ISSUES + 1))
    else
        echo -e "  ${RED}âŒ Mesh not formed ($CONN_COUNT connections)${RESET}"
        echo -e "    ${YELLOW}â†’ Wait longer or check: just logs | grep 'peer connected'${RESET}"
        ISSUES=$((ISSUES + 1))
    fi

    # Check Gossipsub
    echo ""
    echo -e "${BLUE}ðŸ“¢ PubSub Status:${RESET}"
    GOSSIPSUB_ACTIVE=$(docker compose logs 2>&1 | grep -ic "gossipsub" || echo "0")
    if [ "$GOSSIPSUB_ACTIVE" -gt 0 ]; then
        echo -e "  ${GREEN}âœ… Gossipsub active ($GOSSIPSUB_ACTIVE log entries)${RESET}"
    else
        echo -e "  ${RED}âŒ Gossipsub not detected${RESET}"
        ISSUES=$((ISSUES + 1))
    fi

    # Check bootstrap
    echo ""
    echo -e "${BLUE}ðŸš€ Bootstrap Status:${RESET}"
    BOOTSTRAP_SUCCESS=$(docker compose logs 2>&1 | grep -c "All bootstrap peers connected")
    BOOTSTRAP_SUCCESS=${BOOTSTRAP_SUCCESS:-0}
    if [ "$BOOTSTRAP_SUCCESS" -ge 4 ]; then
        echo -e "  ${GREEN}âœ… Bootstrap complete on $BOOTSTRAP_SUCCESS nodes${RESET}"
    else
        echo -e "  ${YELLOW}âš ï¸  Bootstrap incomplete ($BOOTSTRAP_SUCCESS/6 nodes)${RESET}"
        echo -e "    ${YELLOW}â†’ May still be connecting (check logs)${RESET}"
    fi

    # Check for errors in logs
    echo ""
    echo -e "${BLUE}âš ï¸  Error Check:${RESET}"
    ERROR_COUNT=$(docker compose logs 2>&1 | grep -iE "(error|panic|failed)" | grep -vc "wrong peer id" || echo "0")
    if [ "$ERROR_COUNT" -eq 0 ]; then
        echo -e "  ${GREEN}âœ… No errors in logs${RESET}"
    else
        echo -e "  ${YELLOW}âš ï¸  Found $ERROR_COUNT error messages${RESET}"
        echo -e "    ${YELLOW}â†’ Review: just logs | grep -i error${RESET}"
    fi

    # Node endpoints
    echo ""
    echo -e "${BLUE}ðŸ“¡ Node Endpoints:${RESET}"
    for i in {1..6}; do
        NODE_NAME="hermes-node$i"
        if docker compose ps "$NODE_NAME" 2>/dev/null | grep -q "Up"; then
            PORT=$((5000 + (i-1)*2))
            if [ "$i" -eq 1 ]; then PORT=5000; fi
            echo -e "  ${GREEN}âœ…${RESET} Node $i: http://localhost:$PORT"
        else
            echo -e "  ${RED}âŒ${RESET} Node $i: not running"
        fi
    done

    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    if [ $ISSUES -eq 0 ]; then
        echo -e "${GREEN}âœ… All systems operational!${RESET}"
        echo ""
        echo "Next steps:"
        echo "  â€¢ Test propagation: just test-pubsub-propagation"
        echo "  â€¢ View logs: just logs"
        echo "  â€¢ Check dashboard: just dashboard"
        exit 0
    else
        echo -e "${YELLOW}âš ï¸  Found $ISSUES issue(s) - system partially operational${RESET}"
        echo ""
        echo "Troubleshooting:"
        echo "  â€¢ View logs: just logs"
        echo "  â€¢ Full diagnostics: just troubleshoot"
        echo "  â€¢ Restart: just restart"
        exit 1
    fi

# Comprehensive troubleshooting diagnostics
troubleshoot:
    #!/usr/bin/env bash
    set -euo pipefail

    # Color codes
    GREEN='\033[32m'
    RED='\033[31m'
    YELLOW='\033[33m'
    BLUE='\033[34m'
    RESET='\033[0m'

    TIMESTAMP=$(date +%Y%m%d_%H%M%S)
    REPORT_FILE="p2p-troubleshoot-$TIMESTAMP.txt"

    echo -e "${BLUE}ðŸ”§ Running Troubleshooting Diagnostics${RESET}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "Generating report: $REPORT_FILE"
    echo ""

    # Start report
    {
        echo "Hermes P2P Testing - Troubleshooting Report"
        echo "Generated: $(date)"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
    } > "$REPORT_FILE"

    # 1. Prerequisites check
    echo -e "${BLUE}1. Checking prerequisites...${RESET}"
    {
        echo "1. PREREQUISITES"
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        echo ""
    } >> "$REPORT_FILE"
    just validate-prereqs 2>&1 | tee -a "$REPORT_FILE" || true
    echo "" | tee -a "$REPORT_FILE"

    # 2. Docker status
    echo -e "${BLUE}2. Checking Docker status...${RESET}"
    {
        echo "2. DOCKER STATUS"
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        docker compose ps 2>&1 || echo "Failed to get container status"
        echo ""
    } >> "$REPORT_FILE"

    # 3. Docker network
    echo -e "${BLUE}3. Checking Docker network...${RESET}"
    {
        echo "3. DOCKER NETWORK"
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        docker network ls | grep hermes-p2p || echo "Network not found"
        echo ""
        docker network inspect hermes-p2p 2>&1 || echo "Failed to inspect network"
        echo ""
    } >> "$REPORT_FILE"

    # 4. Volume status
    echo -e "${BLUE}4. Checking volumes...${RESET}"
    {
        echo "4. DOCKER VOLUMES"
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        docker volume ls | grep p2p-testing || echo "No volumes found"
        echo ""
    } >> "$REPORT_FILE"

    # 5. Recent logs from each node
    echo -e "${BLUE}5. Collecting logs from all nodes...${RESET}"
    {
        echo "5. NODE LOGS (Last 50 lines per node)"
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        echo ""
    } >> "$REPORT_FILE"

    for i in {1..6}; do
        {
            echo "Node $i Logs:"
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            docker compose logs --tail=50 hermes-node$i 2>&1 || echo "Failed to get logs for node$i"
            echo ""
            echo ""
        } >> "$REPORT_FILE"
    done

    # 6. Peer connections summary
    echo -e "${BLUE}6. Analyzing peer connections...${RESET}"
    {
        echo "6. PEER CONNECTIONS"
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        echo "Total 'New peer connected' messages:"
        docker compose logs 2>&1 | grep "New peer connected" | wc -l
        echo ""
        echo "Recent peer connections:"
        docker compose logs 2>&1 | grep "New peer connected" | tail -10
        echo ""
    } >> "$REPORT_FILE"

    # 7. Error analysis
    echo -e "${BLUE}7. Analyzing errors...${RESET}"
    {
        echo "7. ERROR ANALYSIS"
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        echo "Recent errors (last 20):"
        docker compose logs 2>&1 | grep -iE "(error|panic|failed)" | tail -20 || echo "No errors found"
        echo ""
    } >> "$REPORT_FILE"

    # 8. Port check
    echo -e "${BLUE}8. Checking ports...${RESET}"
    {
        echo "8. PORT STATUS"
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        for PORT in 5000 5002 5004 5006 5008 5010; do
            if ss -tuln 2>/dev/null | grep -q ":$PORT " || netstat -tuln 2>/dev/null | grep -q ":$PORT "; then
                echo "Port $PORT: IN USE"
            else
                echo "Port $PORT: AVAILABLE"
            fi
        done
        echo ""
    } >> "$REPORT_FILE"

    # 9. Common issues check
    {
        echo "9. COMMON ISSUES CHECK"
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        echo ""

        # Check for peer ID mismatches
        PEER_ID_ERRORS=$(docker compose logs 2>&1 | grep -i "wrong peer id" | wc -l)
        if [ "$PEER_ID_ERRORS" -gt 0 ]; then
            echo "âš ï¸  Peer ID mismatches detected ($PEER_ID_ERRORS occurrences)"
            echo "   â†’ Solution: just init-bootstrap"
            echo ""
        fi

        # Check for port conflicts
        if ss -tuln 2>/dev/null | grep -qE ":(5000|5002|5004)" || netstat -tuln 2>/dev/null | grep -qE ":(5000|5002|5004)"; then
            echo "âš ï¸  Port conflicts detected"
            echo "   â†’ Solution: just stop"
            echo ""
        fi

        # Check if volumes exist but nodes not running
        VOLUME_COUNT=$(docker volume ls | grep -c p2p-testing || echo "0")
        RUNNING_COUNT=$(docker compose ps | grep -c "Up" || echo "0")
        if [ "$VOLUME_COUNT" -gt 0 ] && [ "$RUNNING_COUNT" -eq 0 ]; then
            echo "â„¹ï¸  Volumes exist but nodes not running"
            echo "   â†’ Solution: just start"
            echo ""
        fi

        echo "End of diagnostics"
    } >> "$REPORT_FILE"

    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo -e "${GREEN}âœ… Troubleshooting report generated: $REPORT_FILE${RESET}"
    echo ""
    echo "Review the report for detailed diagnostics."
    echo ""
    echo "Common solutions:"
    echo "  â€¢ Peer ID issues: ${BLUE}just init-bootstrap${RESET}"
    echo "  â€¢ Port conflicts: ${BLUE}just stop${RESET}"
    echo "  â€¢ Full reset: ${BLUE}just clean && just start${RESET}"
    echo "  â€¢ View logs: ${BLUE}just logs${RESET}"
    echo ""

# Display status dashboard
dashboard:
    #!/usr/bin/env bash
    set -euo pipefail

    # Color codes
    GREEN='\033[32m'
    RED='\033[31m'
    YELLOW='\033[33m'
    BLUE='\033[34m'
    BOLD='\033[1m'
    RESET='\033[0m'

    echo ""
    echo -e "${BOLD}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${RESET}"
    echo -e "${BOLD}â•‘          Hermes P2P Testing Environment Status             â•‘${RESET}"
    echo -e "${BOLD}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${RESET}"

    # Check each node
    for i in {1..6}; do
        NODE_NAME="hermes-node$i"
        if docker compose ps "$NODE_NAME" 2>/dev/null | grep -q "Up"; then
            STATUS="running"
        else
            STATUS="not running"
        fi

        # Calculate port
        case $i in
            1) PORT=5000 ;;
            2) PORT=5002 ;;
            3) PORT=5004 ;;
            4) PORT=5006 ;;
            5) PORT=5008 ;;
            6) PORT=5010 ;;
        esac

        # Get peer ID (shortened)
        PEER_ID=$(docker compose logs "$NODE_NAME" 2>&1 | grep -oP 'Peer ID: \K12D3[^ ]+' | head -1 | cut -c1-9 || echo "unknown")

        # Count peers for this node
        PEER_COUNT=$(docker compose logs "$NODE_NAME" 2>&1 | grep -c "New peer connected" || echo "0")
        if [ "$PEER_COUNT" -gt 5 ]; then PEER_COUNT=5; fi  # Max 5 peers per node

        # Status indicator
        if [ "$STATUS" = "running" ]; then
            STATUS_ICON="${GREEN}âœ…${RESET}"
            PEER_INFO="${GREEN}$PEER_COUNT peers${RESET}"
        else
            STATUS_ICON="${RED}âŒ${RESET}"
            PEER_INFO="${RED}$STATUS${RESET}"
        fi

        printf "â•‘ Node $i $STATUS_ICON  http://localhost:$PORT  â”‚  %-15b â”‚  $PEER_ID... â•‘\n" "$PEER_INFO"
    done

    echo -e "${BOLD}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${RESET}"

    # Overall mesh status
    RUNNING_NODES=$(docker compose ps | grep -c "Up" || echo "0")
    TOTAL_CONNECTIONS=$(docker compose logs 2>&1 | grep -c "New peer connected" || echo "0")
    GOSSIPSUB_ACTIVE=$(docker compose logs 2>&1 | grep -ic "gossipsub" || echo "0")

    # Mesh status
    if [ "$RUNNING_NODES" -eq 6 ] && [ "$TOTAL_CONNECTIONS" -ge 30 ]; then
        MESH_STATUS="${GREEN}âœ… Healthy${RESET}"
    elif [ "$RUNNING_NODES" -eq 6 ]; then
        MESH_STATUS="${YELLOW}âš ï¸  Forming${RESET}"
    else
        MESH_STATUS="${RED}âŒ Down${RESET}"
    fi

    # PubSub status
    if [ "$GOSSIPSUB_ACTIVE" -gt 0 ]; then
        PUBSUB_STATUS="${GREEN}âœ… Active${RESET}"
    else
        PUBSUB_STATUS="${RED}âŒ Inactive${RESET}"
    fi

    # Calculate uptime (rough estimate from first container)
    UPTIME=$(docker compose ps 2>/dev/null | grep "hermes-node1" | awk '{print $(NF-1), $NF}' || echo "unknown")

    printf "â•‘ Mesh: %-20b â”‚  PubSub: %-20b â”‚  Up: %-10s â•‘\n" "$MESH_STATUS" "$PUBSUB_STATUS" "$UPTIME"
    echo -e "${BOLD}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo ""
    echo -e "${BOLD}Commands:${RESET}"
    echo "  just logs                - View all logs"
    echo "  just test-pubsub         - Test infrastructure"
    echo "  just test-pubsub-propagation  - Test message propagation"
    echo "  just health-check        - Full diagnostics"
    echo "  just troubleshoot        - Debug issues"
    echo ""

# ==============================================================================
# NODE MANAGEMENT
# ==============================================================================

# Start 3-node test environment (interactive: prompts to rebuild if artifacts exist)
start:
    #!/usr/bin/env bash
    set -euo pipefail

    # Check if artifacts exist
    if [ -f "../hermes/target/release/hermes" ] && [ -f "../hermes/apps/athena/athena.happ" ]; then
        echo "ðŸ“¦ Found existing build artifacts"
        read -p "   Rebuild? (y/N): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            just build-all
        fi
    else
        echo "ðŸ—ï¸  No artifacts found, building..."
        just build-all
    fi

    just build-images
    echo ""
    echo "ðŸŒ Starting nodes..."
    docker compose up -d

    echo ""
    echo "â³ Waiting for nodes to initialize..."
    sleep 5

    echo ""
    just status

# Start nodes (CI mode: no prompts, always rebuilds from clean state)
start-ci:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "ðŸš€ Starting P2P test environment (CI mode)..."

    # Ensure clean state
    if docker compose ps | grep -q "Up"; then
        echo "ðŸ§¹ Cleaning existing environment..."
        docker compose down -v
    fi

    just build-ci
    just init-bootstrap
    echo ""
    just status

# Stop nodes (preserves data in Docker volumes)
stop:
    @echo "ðŸ›‘ Stopping nodes..."
    @docker compose down
    @echo "âœ… Nodes stopped (data preserved in volumes)"
    @echo "ðŸ’¡ To remove data: just clean"

# Stop nodes and remove all data (volumes deleted)
# WARNING: After clean, you must run 'just init-bootstrap' to rediscover peer IDs
clean:
    @echo "ðŸ§¹ Stopping nodes and cleaning data..."
    @docker compose down -v
    @echo "âœ… All nodes stopped and data cleaned"
    @echo ""
    @echo "âš ï¸  IMPORTANT: Peer identities were deleted!"
    @echo "   Run 'just init-bootstrap' before 'just start' to rediscover peer IDs"

# ==============================================================================
# BOOTSTRAP PEER DISCOVERY
# ==============================================================================
#
# BACKGROUND: Hermes persists IPFS keypairs in Docker volumes (PR#694)
#   - Keypair location: /home/hermes/.hermes/ipfs/keypair (inside volume)
#   - Peer IDs remain stable across stop/restart (volumes preserved)
#   - This works great for normal operations!
#
# THE PROBLEM: docker-compose.yml has HARDCODED bootstrap peer IDs
#   - Each node's IPFS_BOOTSTRAP_PEERS env var contains specific peer IDs
#   - Example: /ip4/172.20.0.11/tcp/4001/p2p/12D3KooW... (hardcoded)
#   - When 'just clean' deletes volumes, new keypairs = new peer IDs
#   - Hardcoded IDs in docker-compose.yml become stale â†’ mesh formation fails
#   - Errors: "wrong peer id", "Unexpected peer ID", no PubSub propagation
#
# THE SOLUTION: init-bootstrap command (dynamic discovery)
#   Phase 1: Start bootstrap nodes (1-3) to generate/load keypairs
#   Phase 2: Extract actual peer IDs from logs
#   Phase 3: Update docker-compose.yml with discovered IDs (creates backup)
#   Phase 4: Restart all nodes with correct bootstrap configuration
#
# WHEN NEEDED:
#   âœ… After 'just clean' (volumes deleted â†’ new keypairs â†’ new peer IDs)
#   âœ… First time setup (no volumes exist yet)
#   âŒ NOT after 'just stop/restart' (volumes preserved â†’ peer IDs unchanged)
#
# FUTURE IMPROVEMENT: Pre-generated test keypairs (optional convenience)
#   - Generate 6 test keypairs offline: p2p-testing/identities/node{1-6}.keypair
#   - Add to Dockerfile: COPY identities/*.keypair /home/hermes/.hermes/ipfs/
#   - Benefit: Deterministic peer IDs documented in docker-compose.yml comments
#   - Result: No init-bootstrap needed even after 'just clean'
#   - Trade-off: Adds repo size, but eliminates manual step for test environment
#
# ==============================================================================

# Initialize or reinitialize bootstrap configuration after volume changes
# Run this after 'just clean' or when peer IDs change
init-bootstrap:
    #!/usr/bin/env bash
    set -euo pipefail

    echo "ðŸ” Bootstrap Peer Discovery"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "Syncing docker-compose.yml bootstrap config with actual peer IDs"
    echo "(Needed after 'just clean' or first setup)"
    echo ""

    # Check if nodes are running
    if docker compose ps | grep -q "Up"; then
        echo "âš ï¸  Nodes are running. Stopping them first..."
        docker compose down
        sleep 2
    fi

    # Start bootstrap nodes (1-3) without full mesh bootstrap config
    echo "ðŸ“¡ Phase 1: Starting bootstrap nodes (1-3) without inter-node bootstrap..."
    echo "   (They will generate or load their peer identities)"

    # Temporarily disable bootstrap for initial startup
    IPFS_BOOTSTRAP_PEERS="" docker compose up -d hermes-node1 hermes-node2 hermes-node3

    echo "â³ Waiting 15 seconds for nodes to initialize and generate peer IDs..."
    sleep 15

    # Extract peer IDs from running nodes
    echo ""
    echo "ðŸ”Ž Phase 2: Discovering peer IDs from running nodes..."

    PEER_ID_1=$(docker compose logs hermes-node1 2>&1 | grep -E '(Generated new keypair|Loaded keypair) with Peer ID:' | grep -oP '12D3[^ "]+' | head -1)
    PEER_ID_2=$(docker compose logs hermes-node2 2>&1 | grep -E '(Generated new keypair|Loaded keypair) with Peer ID:' | grep -oP '12D3[^ "]+' | head -1)
    PEER_ID_3=$(docker compose logs hermes-node3 2>&1 | grep -E '(Generated new keypair|Loaded keypair) with Peer ID:' | grep -oP '12D3[^ "]+' | head -1)

    if [ -z "$PEER_ID_1" ] || [ -z "$PEER_ID_2" ] || [ -z "$PEER_ID_3" ]; then
        echo "âŒ Failed to discover peer IDs from logs"
        echo "   Node 1: ${PEER_ID_1:-NOT FOUND}"
        echo "   Node 2: ${PEER_ID_2:-NOT FOUND}"
        echo "   Node 3: ${PEER_ID_3:-NOT FOUND}"
        echo ""
        echo "ðŸ’¡ Check logs: docker compose logs"
        exit 1
    fi

    echo "   âœ… Node 1 (172.20.0.10): $PEER_ID_1"
    echo "   âœ… Node 2 (172.20.0.11): $PEER_ID_2"
    echo "   âœ… Node 3 (172.20.0.12): $PEER_ID_3"

    # Update docker-compose.yml with discovered peer IDs
    echo ""
    echo "ðŸ“ Phase 3: Updating docker-compose.yml with discovered peer IDs..."

    # Create backup
    cp docker-compose.yml docker-compose.yml.backup

    # Update bootstrap peers using sed (portable across Linux/Mac)
    # Node 1: bootstrap from nodes 2,3
    sed -i.tmp "s|IPFS_BOOTSTRAP_PEERS=/ip4/172.20.0.11/tcp/4001/p2p/[^,]*,/ip4/172.20.0.12/tcp/4001/p2p/[^\"]*|IPFS_BOOTSTRAP_PEERS=/ip4/172.20.0.11/tcp/4001/p2p/$PEER_ID_2,/ip4/172.20.0.12/tcp/4001/p2p/$PEER_ID_3|g" docker-compose.yml

    # Node 2: bootstrap from nodes 1,3
    sed -i.tmp "s|IPFS_BOOTSTRAP_PEERS=/ip4/172.20.0.10/tcp/4001/p2p/[^,]*,/ip4/172.20.0.12/tcp/4001/p2p/[^\"]*|IPFS_BOOTSTRAP_PEERS=/ip4/172.20.0.10/tcp/4001/p2p/$PEER_ID_1,/ip4/172.20.0.12/tcp/4001/p2p/$PEER_ID_3|g" docker-compose.yml

    # Nodes 3-6: bootstrap from nodes 1,2,3
    sed -i.tmp "s|IPFS_BOOTSTRAP_PEERS=/ip4/172.20.0.10/tcp/4001/p2p/[^,]*,/ip4/172.20.0.11/tcp/4001/p2p/[^,]*,/ip4/172.20.0.12/tcp/4001/p2p/[^\"]*|IPFS_BOOTSTRAP_PEERS=/ip4/172.20.0.10/tcp/4001/p2p/$PEER_ID_1,/ip4/172.20.0.11/tcp/4001/p2p/$PEER_ID_2,/ip4/172.20.0.12/tcp/4001/p2p/$PEER_ID_3|g" docker-compose.yml

    rm -f docker-compose.yml.tmp

    echo "   âœ… docker-compose.yml updated (backup saved as docker-compose.yml.backup)"

    # Restart all nodes with new bootstrap config
    echo ""
    echo "ðŸ”„ Phase 4: Restarting all nodes with correct bootstrap configuration..."
    docker compose down
    sleep 2
    docker compose up -d

    echo "â³ Waiting for mesh to form..."
    sleep 15

    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "âœ… Bootstrap configuration synced!"
    echo ""
    echo "ðŸ“‹ Current Peer IDs (now in docker-compose.yml):"
    echo "   Node 1: $PEER_ID_1"
    echo "   Node 2: $PEER_ID_2"
    echo "   Node 3: $PEER_ID_3"
    echo ""
    echo "ðŸ’¡ Keypairs persist in Docker volumes (PR#694)"
    echo "   - Normal stop/restart: No action needed, peer IDs stay the same"
    echo "   - After 'just clean': Must run 'just init-bootstrap' again"
    echo ""
    echo "ðŸ”® Future: Pre-generate test keypairs to skip this step entirely"
    echo "   See FUTURE IMPROVEMENT in justfile comments"
    echo ""

    just status

# Restart nodes (stop + start, preserves data)
restart: stop start

# Full reset (clean + start fresh with new volumes)
reset: clean start

# ==============================================================================
# MONITORING
# ==============================================================================

# Show node status and endpoints
status:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "ðŸ“Š Node Status:"
    docker compose ps
    echo ""
    echo "ðŸ“¡ Endpoints:"
    echo "   Node 1: http://localhost:5000 (IPFS: 4001, API: 5001) [172.20.0.10]"
    echo "   Node 2: http://localhost:5002 (IPFS: 4002, API: 5003) [172.20.0.11]"
    echo "   Node 3: http://localhost:5004 (IPFS: 4003, API: 5005) [172.20.0.12]"
    echo "   Node 4: http://localhost:5006 (IPFS: 4004, API: 5007) [172.20.0.13]"
    echo "   Node 5: http://localhost:5008 (IPFS: 4005, API: 5009) [172.20.0.14]"
    echo "   Node 6: http://localhost:5010 (IPFS: 4006, API: 5011) [172.20.0.15]"

# Follow logs from all nodes
logs:
    @docker compose logs -f

# Follow logs from specific node (1, 2, or 3)
logs-node node:
    @docker compose logs -f hermes-node{{node}}

# Check P2P connectivity (bootstrap, gossipsub, listening addresses)
check-connectivity:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "ðŸ” Checking P2P connectivity..."
    echo ""

    echo "ðŸ“‹ Bootstrap status:"
    docker compose logs 2>&1 | grep "All bootstrap peers connected" | tail -3 || echo "   âš ï¸  No successful bootstrap connections logged yet"

    echo ""
    echo "ðŸ”— Gossipsub peer connections:"
    docker compose logs 2>&1 | grep "New peer connected" | tail -10 || echo "   âš ï¸  No peer connections found"

    echo ""
    echo "ðŸ‘‚ Listening addresses:"
    docker compose logs 2>&1 | grep "listening on 0.0.0.0:4001" | head -3 || echo "   âš ï¸  Nodes may not be listening on port 4001"

# ==============================================================================
# TESTING
# ==============================================================================

# Run integration tests on all nodes (requires Athena WASM modules)
test: test-node1 test-node2 test-node3 test-node4 test-node5 test-node6
    @echo ""
    @echo "âœ… All nodes tested!"

# Run integration tests on node 1
test-node1:
    @echo "ðŸ§ª Testing Node 1..."
    @docker exec hermes-node1 /usr/local/bin/hermes test || echo "   âš ï¸  Tests not available (Athena not loaded)"

# Run integration tests on node 2
test-node2:
    @echo "ðŸ§ª Testing Node 2..."
    @docker exec hermes-node2 /usr/local/bin/hermes test || echo "   âš ï¸  Tests not available (Athena not loaded)"

# Run integration tests on node 3
test-node3:
    @echo "ðŸ§ª Testing Node 3..."
    @docker exec hermes-node3 /usr/local/bin/hermes test || echo "   âš ï¸  Tests not available (Athena not loaded)"

# Run integration tests on node 4
test-node4:
    @echo "ðŸ§ª Testing Node 4..."
    @docker exec hermes-node4 /usr/local/bin/hermes test || echo "   âš ï¸  Tests not available (Athena not loaded)"

# Run integration tests on node 5
test-node5:
    @echo "ðŸ§ª Testing Node 5..."
    @docker exec hermes-node5 /usr/local/bin/hermes test || echo "   âš ï¸  Tests not available (Athena not loaded)"

# Run integration tests on node 6
test-node6:
    @echo "ðŸ§ª Testing Node 6..."
    @docker exec hermes-node6 /usr/local/bin/hermes test || echo "   âš ï¸  Tests not available (Athena not loaded)"

# Test PubSub infrastructure (connectivity and Gossipsub)
test-pubsub:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "ðŸ§ª Testing PubSub infrastructure..."
    echo ""

    # Check if nodes are running
    if ! docker compose ps | grep -q "hermes-node1.*Up"; then
        echo "âŒ Nodes not running. Start with: just start"
        exit 1
    fi

    echo "1ï¸âƒ£  Checking Gossipsub protocol is active..."
    GOSSIPSUB_LINES=$(docker compose logs 2>&1 | grep -i "gossipsub" | wc -l)
    if [ "$GOSSIPSUB_LINES" -gt 0 ]; then
        echo "   âœ… Gossipsub protocol active ($GOSSIPSUB_LINES log entries)"
    else
        echo "   âŒ Gossipsub not detected"
        exit 1
    fi

    echo ""
    echo "2ï¸âƒ£  Checking peer connections..."
    CONNECTIONS=$(docker compose logs 2>&1 | grep "New peer connected" | wc -l)
    if [ "$CONNECTIONS" -ge 30 ]; then
        echo "   âœ… Full mesh connected ($CONNECTIONS peer connections)"
    else
        echo "   âš ï¸  Only $CONNECTIONS peer connections (expected 30 for 6-node full mesh)"
    fi

    echo ""
    echo "3ï¸âƒ£  Checking bootstrap status..."
    BOOTSTRAP_SUCCESS=$(docker compose logs 2>&1 | grep "All bootstrap peers connected" | wc -l || true)
    if [ "$BOOTSTRAP_SUCCESS" -ge 4 ]; then
        echo "   âœ… Bootstrap complete on $BOOTSTRAP_SUCCESS nodes"
    elif [ "$CONNECTIONS" -ge 20 ]; then
        echo "   âš ï¸  Bootstrap retry still running, but nodes are connected"
    else
        echo "   âš ï¸  Bootstrap incomplete ($BOOTSTRAP_SUCCESS nodes)"
    fi

    echo ""
    echo "âœ… PubSub infrastructure verified (Gossipsub active, peers connected)"

# Test PubSub message propagation (posts from Node 1, verifies others receive)
test-pubsub-propagation:
    #!/usr/bin/env bash
    set -euo pipefail

    # Color codes
    GREEN='\033[32m'
    RED='\033[31m'
    YELLOW='\033[33m'
    BLUE='\033[34m'
    BOLD='\033[1m'
    RESET='\033[0m'

    echo ""
    echo -e "${BOLD}${BLUE}ðŸ§ª Testing PubSub Message Propagation${RESET}"
    echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo ""

    # Explanation
    echo -e "${BOLD}What's happening:${RESET}"
    echo -e "  â€¢ All 6 nodes are subscribed to the ${BLUE}doc-sync${RESET} PubSub topic"
    echo -e "  â€¢ Node 1 will publish a message to this topic"
    echo -e "  â€¢ ${BOLD}Gossipsub${RESET} protocol propagates the message through the mesh"
    echo -e "  â€¢ Each node receives and validates the message"
    echo ""

    # Show network topology with publisher visualization
    echo -e "${BOLD}Why Node 1 is the Publisher:${RESET}"
    echo ""
    echo -e "  ${BLUE}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${RESET}"
    echo -e "  ${BLUE}â”‚${RESET}  Our test sends HTTP POST to Node 1's endpoint:  ${BLUE}â”‚${RESET}"
    echo -e "  ${BLUE}â”‚${RESET}  ${BOLD}http://localhost:5000/api/doc-sync/post${RESET}        ${BLUE}â”‚${RESET}"
    echo -e "  ${BLUE}â”‚${RESET}                                                   ${BLUE}â”‚${RESET}"
    echo -e "  ${BLUE}â”‚${RESET}  â†’ Node 1 receives the message via HTTP          ${BLUE}â”‚${RESET}"
    echo -e "  ${BLUE}â”‚${RESET}  â†’ Node 1 publishes to PubSub topic 'doc-sync'   ${BLUE}â”‚${RESET}"
    echo -e "  ${BLUE}â”‚${RESET}  â†’ Gossipsub propagates to all subscribers       ${BLUE}â”‚${RESET}"
    echo -e "  ${BLUE}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${RESET}"
    echo ""
    echo -e "${BOLD}P2P Mesh Network (Full Connectivity):${RESET}"
    echo ""
    echo "              HTTP POST â¬‡ï¸"
    echo "              (localhost:5000)"
    echo "                    â”‚"
    echo "         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
    echo "         â”‚      Node 1         â”‚ ðŸ“¤ Publisher"
    echo "         â”‚  (Receives HTTP)    â”‚"
    echo "         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
    echo "                    â”‚ Gossipsub"
    echo "            â”Œâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”"
    echo "            â”‚       â”‚       â”‚"
    echo "        â”Œâ”€â”€â”€â–¼â”€â”€â”€â” â”Œâ”€â–¼â”€â”€â”€â” â”Œâ”€â–¼â”€â”€â”€â”"
    echo "        â”‚Node 2 â”‚ â”‚Node3â”‚ â”‚Node4â”‚ ðŸ“¥ Subscribers"
    echo "        â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜"
    echo "            â”‚       â”‚       â”‚"
    echo "            â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”˜"
    echo "                    â”‚"
    echo "            â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”"
    echo "            â”‚               â”‚"
    echo "        â”Œâ”€â”€â”€â–¼â”€â”€â”€â”       â”Œâ”€â”€â”€â–¼â”€â”€â”€â”"
    echo "        â”‚Node 5 â”‚       â”‚Node 6 â”‚ ðŸ“¥ Subscribers"
    echo "        â””â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”˜"
    echo ""
    echo -e "  ${BLUE}â„¹ï¸  Each node is connected to all others (30 total connections)${RESET}"
    echo -e "  ${BLUE}â„¹ï¸  Any node can be a publisher - depends on which receives HTTP POST${RESET}"
    echo ""

    # Check if nodes are running
    RUNNING=$(docker compose ps | grep -c "Up" || echo "0")
    if [ "$RUNNING" -lt 6 ]; then
        echo -e "${RED}âŒ Only $RUNNING/6 nodes running${RESET}"
        echo ""
        echo "Required actions:"
        echo -e "  ${BLUE}â†’ Start nodes: just start${RESET}"
        exit 1
    fi

    echo -e "${GREEN}âœ“${RESET} All 6 nodes running"
    echo ""

    # Wait a bit more for HTTP endpoints to be ready
    echo -e "${BLUE}Waiting for HTTP endpoints to initialize...${RESET}"
    sleep 5

    # Check if Node 1 HTTP endpoint is responding
    echo -n "  Checking Node 1 HTTP endpoint... "
    if curl -s -f -m 5 http://localhost:5000/health >/dev/null 2>&1 || \
       curl -s -f -m 5 http://localhost:5000/ >/dev/null 2>&1; then
        echo -e "${GREEN}âœ“${RESET}"
    else
        echo -e "${YELLOW}âš ï¸  Not responding yet, waiting 10s more...${RESET}"
        sleep 10
    fi

    # Post a unique test message from Node 1
    TIMESTAMP=$(date +%s)
    TEST_MESSAGE="PubSub Test - Timestamp: $TIMESTAMP"

    echo ""
    echo -e "${BOLD}Step 1/3:${RESET} Publishing message to PubSub topic..."
    echo ""
    echo -e "  ${BLUE}â„¹ï¸  Node 1 publishes to topic: ${BOLD}doc-sync${RESET}"
    echo ""
    echo -e "  ${BOLD}ðŸ“¨ Message Content:${RESET}"
    echo -e "  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
    echo -e "  â”‚ ${BLUE}$TEST_MESSAGE${RESET}"
    echo -e "  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
    echo ""

    RESPONSE=$(curl -s -X POST http://localhost:5000/api/doc-sync/post \
      -H "Host: athena.hermes.local" \
      -H "Content-Type: text/plain" \
      -d "$TEST_MESSAGE" 2>&1)

    CID=$(echo "$RESPONSE" | jq -r '.cid' 2>/dev/null || echo "unknown")
    SUCCESS=$(echo "$RESPONSE" | jq -r '.success' 2>/dev/null || echo "false")

    if [ "$SUCCESS" != "true" ]; then
        echo -e "${RED}âŒ Failed to post message!${RESET}"
        echo ""
        echo "Response received:"
        echo "$RESPONSE" | head -20
        echo ""
        echo "Possible causes:"
        echo "  â€¢ Node 1 HTTP endpoint not ready (Athena app still loading)"
        echo "  â€¢ Network connectivity issue"
        echo "  â€¢ Doc-sync module not initialized"
        echo ""
        echo "Troubleshooting:"
        echo -e "  ${BLUE}â†’ Check if Athena loaded: just logs-node 1 | grep 'Loading application'${RESET}"
        echo -e "  ${BLUE}â†’ Check endpoint: curl -v http://localhost:5000/${RESET}"
        echo -e "  ${BLUE}â†’ Full diagnostics: just troubleshoot${RESET}"
        echo -e "  ${BLUE}â†’ Wait and retry: sleep 30 && just test-pubsub-propagation${RESET}"
        exit 1
    fi

    echo -e "${GREEN}âœ“${RESET} Message published successfully"
    echo -e "  ${BOLD}ðŸ”‘ Content ID (CID):${RESET} ${BLUE}$CID${RESET}"
    echo -e "  ${BLUE}â„¹ï¸  CID is the IPFS content hash (cryptographic fingerprint)${RESET}"
    echo ""
    echo -e "  ${BOLD}ðŸ“¡ Broadcasting via Gossipsub protocol...${RESET}"
    echo -e "  ${BLUE}â„¹ï¸  Message propagates through mesh to all subscribed peers${RESET}"
    echo ""

    # Wait for PubSub propagation with countdown
    echo -e "${BOLD}Step 2/3:${RESET} Waiting for P2P propagation..."
    echo -e "  ${BLUE}â„¹ï¸  Gossipsub forwards message through peer connections${RESET}"
    for i in {3..1}; do
        echo -ne "  â³ ${i}s remaining...\r"
        sleep 1
    done
    echo -e "${GREEN}âœ“${RESET} Initial wait complete              "
    echo ""

    # Check which nodes received the message with animation
    echo -e "${BOLD}Step 3/3:${RESET} Monitoring message reception..."
    echo ""
    echo -e "  ${BLUE}â„¹ï¸  Checking logs for PubSub message receipts on each node${RESET}"
    echo -e "  ${BLUE}â„¹ï¸  Each node validates the message signature and CID${RESET}"
    echo ""

    RECEIVED_COUNT=0
    START_TIME=$(date +%s)

    # Visual representation of nodes
    declare -A NODE_STATUS
    declare -A NODE_RECEIVE_TIME
    PUBLISH_TIME=$START_TIME

    for i in {2..6}; do
        NODE_STATUS[$i]="â³"
        NODE_RECEIVE_TIME[$i]="0"
    done

    # Check nodes in real-time with animation
    MAX_WAIT=5  # Check for 5 seconds
    for SECOND in $(seq 1 $MAX_WAIT); do
        # Check each node
        for NODE in {2..6}; do
            if [ "${NODE_STATUS[$NODE]}" = "â³" ]; then
                NODE_NAME="hermes-node$NODE"
                if docker compose logs "$NODE_NAME" 2>&1 | grep "RECEIVED PubSub message" | grep -q "$TIMESTAMP"; then
                    NODE_STATUS[$NODE]="âœ…"
                    NODE_RECEIVE_TIME[$NODE]=$(date +%s)
                    RECEIVED_COUNT=$((RECEIVED_COUNT + 1))
                    LATENCY=$((NODE_RECEIVE_TIME[$NODE] - PUBLISH_TIME))
                    echo -e "  ${GREEN}âœ¨ Node $NODE received message${RESET} (${LATENCY}s) â†’ ${BLUE}\"$TEST_MESSAGE\"${RESET}"
                fi
            fi
        done

        # Show progress
        if [ $RECEIVED_COUNT -lt 5 ]; then
            echo -ne "\r  Waiting... ${SECOND}s  [${NODE_STATUS[2]} ${NODE_STATUS[3]} ${NODE_STATUS[4]} ${NODE_STATUS[5]} ${NODE_STATUS[6]}]"
            sleep 1
        else
            echo -ne "\r  ${GREEN}âœ… All nodes received!${RESET}                                    \n"
            break
        fi
    done
    echo ""

    # Calculate statistics
    END_TIME=$(date +%s)
    TOTAL_TIME=$((END_TIME - START_TIME))
    MSG_SIZE=$(echo -n "$TEST_MESSAGE" | wc -c)
    CID_SIZE=$(echo -n "$CID" | wc -c)

    # Final status display
    echo ""
    echo -e "${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
    echo -e "${BOLD}1. PROPAGATION TIMELINE â±ï¸${RESET}"
    echo -e "${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
    echo ""
    echo -e "  ${BLUE}0.0s${RESET} â†’ ${BOLD}Node 1 publishes message${RESET}"

    for NODE in {2..6}; do
        if [ "${NODE_STATUS[$NODE]}" = "âœ…" ]; then
            RECV_TIME=$((NODE_RECEIVE_TIME[$NODE] - PUBLISH_TIME))
            echo -e "  ${GREEN}${RECV_TIME}.0s${RESET} â†’ Node $NODE received (${GREEN}+${RECV_TIME}s${RESET})"
        fi
    done

    for NODE in {2..6}; do
        if [ "${NODE_STATUS[$NODE]}" != "âœ…" ]; then
            echo -e "  ${RED}---${RESET} â†’ Node $NODE ${RED}did not receive${RESET}"
        fi
    done

    echo ""
    echo -e "${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
    echo -e "${BOLD}2. NETWORK STATISTICS ðŸ“Š${RESET}"
    echo -e "${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
    echo ""
    echo -e "  ${BOLD}Message Metrics:${RESET}"
    echo -e "    â€¢ Message Size: ${BLUE}${MSG_SIZE} bytes${RESET}"
    echo -e "    â€¢ CID Size: ${BLUE}${CID_SIZE} bytes${RESET}"
    echo -e "    â€¢ Total Payload: ${BLUE}$((MSG_SIZE + CID_SIZE)) bytes${RESET}"
    echo ""
    echo -e "  ${BOLD}Network Metrics:${RESET}"
    echo -e "    â€¢ Total Nodes: ${BLUE}6${RESET}"
    echo -e "    â€¢ Total Connections: ${BLUE}30${RESET} (full mesh)"
    echo -e "    â€¢ Subscriber Nodes: ${BLUE}5${RESET}"
    echo -e "    â€¢ Success Rate: ${GREEN}$((RECEIVED_COUNT * 100 / 5))%${RESET} (${RECEIVED_COUNT}/5)"
    echo ""
    echo -e "  ${BOLD}Performance:${RESET}"
    echo -e "    â€¢ Total Propagation Time: ${BLUE}~${TOTAL_TIME}s${RESET}"
    if [ $RECEIVED_COUNT -gt 0 ]; then
        AVG_TIME=$((TOTAL_TIME))
        echo -e "    â€¢ Average Latency: ${BLUE}~${AVG_TIME}s per node${RESET}"
    fi
    echo -e "    â€¢ Protocol: ${BLUE}Gossipsub v1.2 (libp2p)${RESET}"
    echo ""
    echo -e "${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
    echo -e "${BOLD}3. LIVE LOG PREVIEW ðŸ“œ${RESET}"
    echo -e "${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
    echo ""
    echo -e "  ${BOLD}Recent PubSub activity (last 3 entries):${RESET}"
    echo ""

    # Show recent log entries from nodes that received the message
    for NODE in {2..3}; do
        if [ "${NODE_STATUS[$NODE]}" = "âœ…" ]; then
            echo -e "  ${BLUE}[Node $NODE]${RESET}"
            docker compose logs hermes-node$NODE 2>&1 | grep -E "(RECEIVED PubSub|gossipsub|doc-sync)" | grep "$TIMESTAMP" | tail -1 | sed 's/^/    /' || echo "    (no detailed logs)"
            echo ""
        fi
    done

    echo -e "${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
    echo -e "${BOLD}5. PEER CONNECTIONS ðŸ”—${RESET}"
    echo -e "${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
    echo ""

    # Get peer connection counts
    PEER_CONN=$(docker compose logs 2>&1 | grep -c "New peer connected" || echo "0")
    echo -e "  ${BOLD}Active P2P Connections:${RESET}"
    echo -e "    â€¢ Total peer connections logged: ${BLUE}${PEER_CONN}${RESET}"
    echo -e "    â€¢ Expected connections: ${BLUE}30${RESET} (each node connects to 5 others)"
    echo ""
    echo -e "  ${BOLD}Connection Matrix (Full Mesh):${RESET}"
    echo -e "    Node 1 âŸ· Node 2, Node 3, Node 4, Node 5, Node 6"
    echo -e "    Node 2 âŸ· Node 1, Node 3, Node 4, Node 5, Node 6"
    echo -e "    Node 3 âŸ· Node 1, Node 2, Node 4, Node 5, Node 6"
    echo -e "    Node 4 âŸ· Node 1, Node 2, Node 3, Node 5, Node 6"
    echo -e "    Node 5 âŸ· Node 1, Node 2, Node 3, Node 4, Node 6"
    echo -e "    Node 6 âŸ· Node 1, Node 2, Node 3, Node 4, Node 5"
    echo ""
    echo -e "  ${BLUE}â„¹ï¸  Each node maintains 5 peer connections (5 peers Ã— 6 nodes = 30 total)${RESET}"

    echo ""
    echo -e "${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
    echo -e "${BOLD}FINAL STATUS ðŸ“‹${RESET}"
    echo -e "${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
    echo ""
    echo -e "  ${BOLD}ðŸ“¨ Message:${RESET} ${BLUE}\"$TEST_MESSAGE\"${RESET}"
    echo -e "  ${BOLD}ðŸ”‘ CID:${RESET} ${BLUE}$CID${RESET}"
    echo -e "  ${BOLD}ðŸ“¡ Topic:${RESET} ${BLUE}doc-sync${RESET}"
    echo ""
    echo -e "  ${BOLD}Reception Status:${RESET}"
    for NODE in {2..6}; do
        if [ "${NODE_STATUS[$NODE]}" = "âœ…" ]; then
            RECV_TIME=$((NODE_RECEIVE_TIME[$NODE] - PUBLISH_TIME))
            echo -e "    ${GREEN}âœ… Node $NODE: RECEIVED${RESET} (${RECV_TIME}s)"
        else
            NODE_STATUS[$NODE]="âŒ"
            echo -e "    ${RED}âŒ Node $NODE: Did NOT receive${RESET}"
        fi
    done

    echo ""
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
    echo ""

    # Evaluate results
    if [ "$RECEIVED_COUNT" -eq 5 ]; then
        echo -e "${BOLD}${GREEN}âœ… SUCCESS - Perfect Propagation!${RESET}"
        echo ""
        echo -e "  â€¢ ${GREEN}All 5 nodes${RESET} received the message"
        echo -e "  â€¢ Latency: ~${LATENCY}s"
        echo -e "  â€¢ Mesh status: ${GREEN}Healthy${RESET}"
        echo ""
        exit 0
    elif [ "$RECEIVED_COUNT" -ge 4 ]; then
        echo -e "${BOLD}${GREEN}âœ… SUCCESS - Good Propagation${RESET}"
        echo ""
        echo -e "  â€¢ ${GREEN}$RECEIVED_COUNT/5 nodes${RESET} received the message"
        echo -e "  â€¢ Latency: ~${LATENCY}s"
        echo -e "  â€¢ Mesh status: ${GREEN}Operational${RESET}"
        echo ""
        exit 0
    elif [ "$RECEIVED_COUNT" -gt 0 ]; then
        echo -e "${BOLD}${YELLOW}âš ï¸  PARTIAL - Incomplete Propagation${RESET}"
        echo ""
        echo -e "  â€¢ Only ${YELLOW}$RECEIVED_COUNT/5 nodes${RESET} received the message"
        echo -e "  â€¢ Expected: 4-5 nodes"
        echo -e "  â€¢ Mesh status: ${YELLOW}Degraded${RESET}"
        echo ""
        echo "Possible causes:"
        echo "  â€¢ Mesh still forming (wait longer)"
        echo "  â€¢ Some nodes not subscribed to topic"
        echo "  â€¢ Network connectivity issues"
        echo ""
        echo "Troubleshooting:"
        echo -e "  ${BLUE}â†’ Check health: just health-check${RESET}"
        echo -e "  ${BLUE}â†’ View logs: just logs | grep -i pubsub${RESET}"
        echo -e "  ${BLUE}â†’ Restart nodes: just restart${RESET}"
        exit 1
    else
        echo -e "${BOLD}${RED}âŒ FAILED - No Propagation${RESET}"
        echo ""
        echo -e "  â€¢ ${RED}No nodes${RESET} received the message"
        echo -e "  â€¢ Mesh status: ${RED}Broken${RESET}"
        echo ""
        echo "Possible causes:"
        echo "  â€¢ PubSub mesh not formed"
        echo "  â€¢ Nodes not subscribed to topic"
        echo "  â€¢ Bootstrap issues"
        echo ""
        echo "Troubleshooting:"
        echo -e "  ${BLUE}â†’ Check connectivity: just check-connectivity${RESET}"
        echo -e "  ${BLUE}â†’ Full diagnostics: just troubleshoot${RESET}"
        echo -e "  ${BLUE}â†’ Reset bootstrap: just init-bootstrap${RESET}"
        echo -e "  ${BLUE}â†’ Check logs: just logs | grep -E '(RECEIVED|gossipsub|bootstrap)'${RESET}"
        exit 1
    fi

# Full CI test suite (status + connectivity + pubsub)
test-ci:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "ðŸ§ª Running CI test suite..."
    echo ""

    # Check node status
    echo "ðŸ“Š Node status check..."
    RUNNING=$(docker compose ps | grep -c "Up" || true)
    if [ "$RUNNING" -ne 6 ]; then
        echo "âŒ Expected 6 nodes running, found $RUNNING"
        exit 1
    fi
    echo "   âœ… All 6 nodes running"

    # Wait for initialization
    echo ""
    echo "â³ Waiting for nodes to initialize (15s)..."
    sleep 15

    # Check connectivity
    echo ""
    echo "ðŸ”— Connectivity check..."
    just check-connectivity

    # Test PubSub infrastructure
    echo ""
    just test-pubsub

    # Test PubSub message propagation (end-to-end)
    echo ""
    just test-pubsub-propagation

    echo ""
    echo "âœ… CI test suite passed!"

# ==============================================================================
# HELP
# ==============================================================================

# Show detailed help with examples
help:
    @echo "================================================================================"
    @echo "Hermes P2P Testing Environment"
    @echo "================================================================================"
    @echo ""
    @echo "QUICK START (First Time):"
    @echo "  just quickstart         # Does everything: build, start, test, verify!"
    @echo ""
    @echo "QUICK START (Daily):"
    @echo "  just start              # Start 6 nodes (waits for mesh formation)"
    @echo "  just dashboard          # Check status"
    @echo "  just test-pubsub-propagation  # Test message propagation"
    @echo "  just logs               # Monitor activity"
    @echo "  just stop               # Stop nodes (preserves peer IDs)"
    @echo ""
    @echo "COMMON WORKFLOWS:"
    @echo ""
    @echo "  First-Time Setup:"
    @echo "    just quickstart       # Complete end-to-end setup and test"
    @echo ""
    @echo "  Developer Testing:"
    @echo "    just validate-prereqs # Check prerequisites"
    @echo "    just start            # Interactive mode, prompts to rebuild"
    @echo "    just dashboard        # View live status"
    @echo "    just health-check     # Comprehensive health check"
    @echo "    just test-pubsub-propagation  # Test message propagation"
    @echo "    just logs-node 1      # Debug specific node"
    @echo "    just restart          # Apply code changes"
    @echo ""
    @echo "  CI/CD Pipeline:"
    @echo "    just start-ci         # CI mode: non-interactive, always rebuilds"
    @echo "    just test-ci          # Full validation suite"
    @echo "    just clean            # Cleanup (deletes peer IDs)"
    @echo ""
    @echo "  Troubleshooting:"
    @echo "    just health-check     # Check system health"
    @echo "    just troubleshoot     # Generate diagnostic report (saves to file)"
    @echo "    just check-connectivity  # Check P2P connectivity"
    @echo "    just init-bootstrap   # Reset bootstrap (auto-runs on first start)"
    @echo ""
    @echo "  From Scratch (simulates fresh git clone):"
    @echo "    just clean            # Remove everything"
    @echo "    just build-all        # Build from scratch"
    @echo "    just quickstart       # Start and verify"
    @echo ""
    @echo "BUILD COMMANDS:"
    @echo "  build                   Build Hermes binary only (fast)"
    @echo "  build-all               Build Hermes + Athena WASM (fast, ~1-2 min)"
    @echo "  build-images            Build Docker images"
    @echo "  build-ci                Build everything (CI mode)"
    @echo ""
    @echo "VALIDATION & DIAGNOSTICS:"
    @echo "  validate-prereqs        Check all prerequisites"
    @echo "  health-check            Comprehensive system health check"
    @echo "  dashboard               Live status display with node info"
    @echo "  troubleshoot            Generate full diagnostic report"
    @echo "  check-connectivity      Check P2P connectivity status"
    @echo ""
    @echo "NODE MANAGEMENT:"
    @echo "  quickstart              Complete end-to-end setup and test"
    @echo "  start                   Start nodes (interactive mode, prompts)"
    @echo "  start-ci                Start nodes (CI mode, always rebuilds, no prompts)"
    @echo "  init-bootstrap          Initialize/reset bootstrap (auto-runs on first start)"
    @echo "  stop                    Stop nodes (preserves peer IDs)"
    @echo "  clean                   Stop and remove data (DELETES PEER IDs)"
    @echo "  restart                 Stop + start"
    @echo "  reset                   Clean + start fresh (regenerates peer IDs)"
    @echo ""
    @echo "MONITORING:"
    @echo "  status                  Show node status and endpoints"
    @echo "  dashboard               Live status with health indicators"
    @echo "  logs                    Follow all logs"
    @echo "  logs-node N             Follow node N logs (1-6)"
    @echo ""
    @echo "TESTING:"
    @echo "  test                    Run integration tests on all nodes"
    @echo "  test-nodeN              Test specific node (1-6)"
    @echo "  test-pubsub             Test PubSub infrastructure"
    @echo "  test-pubsub-propagation Test end-to-end message propagation"
    @echo "  test-ci                 Full CI test suite"
    @echo ""
    @echo "NODE ENDPOINTS:"
    @echo "  Node 1: http://localhost:5000 (IPFS: 4001) [172.20.0.10]"
    @echo "  Node 2: http://localhost:5002 (IPFS: 4002) [172.20.0.11]"
    @echo "  Node 3: http://localhost:5004 (IPFS: 4003) [172.20.0.12]"
    @echo "  Node 4: http://localhost:5006 (IPFS: 4004) [172.20.0.13]"
    @echo "  Node 5: http://localhost:5008 (IPFS: 4005) [172.20.0.14]"
    @echo "  Node 6: http://localhost:5010 (IPFS: 4006) [172.20.0.15]"
    @echo ""
    @echo "IMPORTANT NOTES:"
    @echo "  â€¢ After 'just clean', peer IDs are regenerated on next start"
    @echo "  â€¢ Mesh formation happens automatically after startup"
    @echo "  â€¢ 'start' = interactive (prompts), 'start-ci' = CI mode (always rebuilds)"
    @echo "  â€¢ Use 'just stop' (not clean) to preserve peer IDs between restarts"
    @echo ""
    @echo "WHY 6 NODES:"
    @echo "  Gossipsub default mesh_n=6 requires 6+ peers for optimal operation."
    @echo "  With fewer nodes, PubSub publish operations block waiting for mesh."
    @echo "  Alternative: fork rust-ipfs to add small mesh configuration support."
    @echo ""
    @echo "FEATURES:"
    @echo "  â€¢ Persistent peer IDs (keypairs stored in volumes)"
    @echo "  â€¢ Bootstrap retry logic (10s interval, 10 max attempts)"
    @echo "  â€¢ Gossipsub v1.2 PubSub protocol"
    @echo "  â€¢ Full mesh connectivity (each node connected to others)"
    @echo "  â€¢ Isolated Docker network (172.20.0.0/16)"
    @echo "  â€¢ Color-coded output with helpful error messages"
    @echo "  â€¢ Comprehensive diagnostics and troubleshooting"
    @echo ""
    @echo "DOCUMENTATION:"
    @echo "  README.md               Quick start guide"
    @echo "  TROUBLESHOOTING.md      Comprehensive debugging guide"
    @echo "  justfile                Full command documentation (cat justfile)"
    @echo ""
    @echo "For more info: cat justfile or just --list"
    @echo "================================================================================"
